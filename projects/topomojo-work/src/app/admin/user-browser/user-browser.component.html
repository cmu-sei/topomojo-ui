<!-- Copyright 2021 Carnegie Mellon University. -->
<!-- Released under a 3 Clause BSD-style license. See LICENSE.md in the project root. -->

<h4>Users</h4>

<div class="text-muted mb-2">
  Manage TopoMojo users and permissions. Search by name, filter by role or audience (scope), and view/edit limits and
  access settings for each user.
</div>

<div>
  <div class="input-group input-group-sm">
    <div class="input-group-prepend">
      <span class="input-group-text" id="user-search-label">
        <fa-icon [icon]="faSearch"></fa-icon>
        <span>Search</span>
      </span>
    </div>
    <input
      type="search"
      [(ngModel)]="search.term"
      placeholder="term"
      class="form-control"
      (input)="termed()"
      aria-label="Search users"
      aria-describedby="user-search-label"
    >
  </div>

  <small class="text-muted">
    Search by user name. You can also narrow results using role and scope filters below.
  </small>

  <div class="mt-1">
    <button
      class="btn btn-link text-primary btn-sm"
      (click)="create()"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Create a new user.'"
      aria-label="Create a new user."
    >
      create
    </button>
    |
    <button
      class="mr-1 btn btn-link text-success btn-sm"
      (click)="toggleFilter('administrator')"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Filter to administrators.'"
      aria-label="Filter to administrators."
    >
      <fa-icon [hidden]="filter!=='administrator'" [icon]="faFilter"></fa-icon>
      <span>admins</span>
    </button>
    <button
      class="mr-1 btn btn-link text-pink btn-sm"
      (click)="toggleFilter('observer')"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Filter to observers.'"
      aria-label="Filter to observers."
    >
      <fa-icon [hidden]="filter!=='observer'" [icon]="faFilter"></fa-icon>
      <span>observers</span>
    </button>
    <button
      class="mr-1 btn btn-link text-secondary btn-sm"
      (click)="toggleFilter('creator')"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Filter to creators.'"
      aria-label="Filter to creators."
    >
      <fa-icon [hidden]="filter!=='creator'" [icon]="faFilter"></fa-icon>
      <span>creators</span>
    </button>
    <button
      class="mr-1 btn btn-link text-warning btn-sm"
      (click)="toggleFilter('builder')"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Filter to builders.'"
      aria-label="Filter to builders."
    >
      <fa-icon [hidden]="filter!=='builder'" [icon]="faFilter"></fa-icon>
      <span>builders</span>
    </button>
    |
    <button
      class="mx-1 btn btn-link text-primary btn-sm"
      (click)="toggleServiceAccountFilter()"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Filter to service accounts.'"
      aria-label="Filter to service accounts."
    >
      <fa-icon [hidden]="!search.isServiceAccount" [icon]="faFilter"></fa-icon>
      <span>service accounts</span>
    </button>
    |
    <button
      *ngFor="let s of scopes"
      class="mr-1 btn btn-link text-dark btn-sm"
      (click)="toggleScope(s)"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Filter to users in scope: ' + s"
      [attr.aria-label]="'Filter to users in scope: ' + s"
    >
      <fa-icon [hidden]="scope!==s" [icon]="faFilter"></fa-icon>
      <span>{{s}}</span>
    </button>
  </div>
</div>

<app-pager [skip]="skip" [take]="take" [count]="count" (changed)="paged($event)"></app-pager>
<hr class="mt-0 mb-2" />

<div class="row mb-2 workspace-header align-items-center">
  <div class="col-6">
    <button
      type="button"
      class="btn btn-link p-0 sort-header header-label text-primary"
      (click)="sortBy('name')"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Sort by user name.'"
      aria-label="Sort by user name."
    >
      User Name
      <fa-icon *ngIf="sortField === 'name'" [icon]="sortAscending ? faSortUp : faSortDown"></fa-icon>
    </button>
  </div>

  <div class="col-2">
    <button
      type="button"
      class="btn btn-link p-0 sort-header header-label text-primary d-inline-flex align-items-center"
      (click)="sortBy('created')"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Sort by account creation date.'"
      aria-label="Sort by account creation date."
    >
      Created Date
      <fa-icon *ngIf="sortField === 'created'" [icon]="sortAscending ? faSortUp : faSortDown"></fa-icon>
    </button>
  </div>

  <div class="col-4 align-self-center text-right">
    <span class="header-label text-primary">Actions</span>
  </div>
</div>

<div
  *ngFor="let user of source$ | async; trackBy:trackById"
  class="row mb-1"
  [class.pop-success]="user.role==='administrator'"
  [class.pop-secondary]="user.role==='creator'"
  [class.pop-warning]="user.role==='builder'"
  [class.pop-pink]="user.role==='observer'"
>
  <div class="col-6">
    <span class="text-secondary">{{user.name}}</span>
    <br />
    <div class="d-flex align-items-center my-1">
      @if (user.serviceAccountClientId)
      {
        <div class="badge badge-sm badge-secondary mr-2">Service Account</div>
      }
      <small class="d-block text-muted">
        <app-clipspan>{{user.id}}</app-clipspan>
      </small>
    </div>
  </div>

  <div class="col-2 align-self-center">
    <small>{{user.whenCreated | shortdate}}</small>
  </div>

  <div class="col-4 align-self-center text-right tm-actions">
    <button
      class="btn btn-outline-info btn-sm tm-action-btn"
      (click)="view(user)"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'View and edit this user’s settings.'"
      aria-label="View and edit this user’s settings."
    >
      <fa-icon [icon]="faList"></fa-icon>
      <span>View</span>
    </button>

    <app-confirm-button
      class="tm-action-host"
      btnClass="btn btn-outline-danger btn-sm tm-action-btn"
      (confirm)="delete(user)"
      aria-label="delete user"
    >
      <fa-icon [icon]="faTrash"></fa-icon>
      <span>Delete</span>
    </app-confirm-button>
  </div>

  <div *ngIf="viewed === user" class="col-12">
    @if (user.role === 'administrator' && user.serviceAccountClientId)
    {
      <alert type="danger" [dismissible]="true">
        <strong>NOTE:</strong>
        <div>
          This user is currently configured as an administrator and has a service account client ID. For security reasons,
          this is generally <strong>not advisable</strong>. We recommend that service account users have the
          <strong>Observer</strong> role at maximum.
        </div>
      </alert>
    }

    <div class="form-group bg-light">
      <label class="d-block mb-0 d-flex align-items-center" for="role-input">
        Role
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Roles are additive: Creator includes Builder, and Admin includes everything. Disabled removes permissions.'"
          aria-label="Roles are additive: Creator includes Builder, and Admin includes everything. Disabled removes permissions."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>

      <div
        id="role-input"
        class="my-2 btn-group"
        btnRadioGroup
        [(ngModel)]="user.appRole"
        (click)="updateRole(user, user.appRole)"
      >
        <label class="btn btn-outline-info btn-sm" btnRadio="user">User</label>
        <label class="btn btn-outline-info btn-sm" btnRadio="builder">Builder</label>
        <label class="btn btn-outline-info btn-sm" btnRadio="creator">Creator</label>
        <label class="btn btn-outline-info btn-sm" btnRadio="observer">Observer</label>
        <label class="btn btn-outline-info btn-sm" btnRadio="administrator">Admin</label>
        <label class="btn btn-outline-info btn-sm" btnRadio="disabled">Disabled</label>
      </div>

      <small class="text-muted d-block">
        Builder: bypasses some checks (e.g., blocking bridge-net). Creator: bypasses workspace/template limits.
      </small>

      <app-user-role-badge class="mx-2 mb-2" [user]="user"></app-user-role-badge>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="name-input">
        Name
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Display name for this user. For client `user`, the name may be overwritten by the auth token.'"
          aria-label="Display name for this user. For client 'user', the name may be overwritten by the auth token."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input id="name-input" class="form-control" type="text" [(ngModel)]="user.name" (change)="update(user)">
      <small class="text-muted">For regular users, names may update from the authentication token.</small>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="scope-input">
        Scope
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Space-delimited audience groups this user belongs to. Users can only deploy/play workspaces whose Audience matches one of these scope tags.'"
          aria-label="Space-delimited audience groups this user belongs to. Users can only deploy/play workspaces whose Audience matches one of these scope tags."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input id="scope-input" class="form-control" type="text" [(ngModel)]="user.scope" (change)="update(user)">
      <small class="text-muted">
        Audience groups (space-delimited). Controls which workspaces this user can deploy/play.
      </small>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="input-wslimit">
        Workspace Limit
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Maximum number of workspaces this user can manage.'"
          aria-label="Maximum number of workspaces this user can manage."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input id="input-wslimit" class="form-control" type="number" [(ngModel)]="user.workspaceLimit" (change)="update(user)">
      <small class="text-muted">Max workspaces this user can manage.</small>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="input-gslimit">
        Gamespace Limit
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Maximum number of concurrent gamespaces this user can run at the same time.'"
          aria-label="Maximum number of concurrent gamespaces this user can run at the same time."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input id="input-gslimit" class="form-control" type="number" [(ngModel)]="user.gamespaceLimit" (change)="update(user)">
      <small class="text-muted">Max concurrent gamespaces allowed.</small>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="input-gsduration">
        Gamespace Max Duration
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Maximum allowed duration (in minutes) for a gamespace launched by this user.'"
          aria-label="Maximum allowed duration (in minutes) for a gamespace launched by this user."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input id="input-gsduration" class="form-control" type="number" [(ngModel)]="user.gamespaceMaxMinutes" (change)="update(user)">
      <small class="text-muted">Max minutes allowed for a gamespace.</small>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="input-gscleanup">
        Gamespace Cleanup Grace time
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Grace period (minutes) between gamespace expiration and teardown.'"
          aria-label="Grace period (minutes) between gamespace expiration and teardown."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input
        id="input-gscleanup"
        class="form-control"
        type="number"
        [(ngModel)]="user.gamespaceCleanupGraceMinutes"
        (change)="update(user)"
      >
      <small class="text-muted">Grace minutes between expiration and teardown.</small>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center" for="input-serviceAccountClientId">
        Service Account Client Id
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Marks this user as a service account for client credentials authorization. Recommended role: Observer or lower.'"
          aria-label="Marks this user as a service account for client credentials authorization. Recommended role: Observer or lower."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <input
        id="input-serviceAccountClientId"
        class="form-control"
        [(ngModel)]="user.serviceAccountClientId"
        (change)="update(user)"
      >
      <div>
        <small class="text-muted">
          Enables client credentials auth for automation/API use. Avoid combining with Admin where possible.
        </small>
      </div>
    </div>

    <div class="form-group bg-light">
      <label class="mb-0 d-flex align-items-center">
        ApiKeys
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Generate and manage API keys so this user can interact with the TopoMojo API programmatically.'"
          aria-label="Generate and manage API keys so this user can interact with the TopoMojo API programmatically."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>
      <app-apikeys [id]="user.id"></app-apikeys>
    </div>
  </div>
</div>

<hr class="my-0" />
<app-pager [skip]="skip" [take]="take" [count]="count" (changed)="paged($event)"></app-pager>
