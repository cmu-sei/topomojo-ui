<!-- Copyright 2021 Carnegie Mellon University. -->
<!-- Released under a 3 Clause BSD-style license. See LICENSE.md in the project root. -->
<h4>Workspaces</h4>
<div class="mb-2">
  <div class="text-muted">
    Browse and manage workspaces. Search by name or identifier, open a workspace to edit it, and use View to inspect
    limits, scope, audience, and deployed VM controls.
  </div>
</div>

<div class="mb-2">
  <div class="input-group input-group-sm">
    <div class="input-group-prepend">
      <span
        class="input-group-text"
        placement="right"
        container="body"
        triggers="hover focus"
        [tooltip]="'Search for a workspace by name or identifier.'"
        aria-label="Search for a workspace by name or identifier."
      >
        <fa-icon [icon]="faSearch"></fa-icon>
        <span>Search</span>
      </span>
    </div>
    <input
      type="search"
      [(ngModel)]="search.term"
      placeholder="term"
      class="form-control"
      (input)="termed()"
      aria-label="search workspaces"
    >
  </div>

  <input
    type="checkbox"
    [checked]="areAllSelected()"
    (change)="selectAll($event)"
    class="select-all"
    *ngIf="selectDownloads"
    [tooltip]="'Select or deselect all workspaces on this page for download.'"
    placement="right"
    container="body"
    triggers="hover focus"
    aria-label="Select or deselect all workspaces on this page for download."
  >

  <ng-container *ngIf="!selectDownloads">
    <button
      class="btn btn-sm btn-link text-primary"
      (click)="showCreatePanel=!showCreatePanel"
      placement="right"
      [tooltip]="'Create a new workspace.'"
      aria-label="Create a new workspace."
      container="body"
      triggers="hover focus"
    >
      <fa-icon [icon]="faPlus"></fa-icon>
      <span>Create</span>
    </button>

    <button
      class="btn btn-sm btn-link text-primary"
      (click)="zipInput.click()"
      placement="top"
      [tooltip]="'Upload a workspace export (.zip) to import a workspace.'"
      container="body"
      triggers="hover focus"
      aria-label="Upload a workspace export (.zip) to import a workspace."
    >
      <fa-icon [icon]="faFile"></fa-icon>
      <span>UploadZip</span>
      <input class="invisible" (change)="upload($event)" #zipInput type="file" accept=".zip,.json" />
    </button>

    <button
      class="btn btn-sm btn-link text-primary"
      (click)="selectDownloads = true"
      *ngIf="!selectDownloads"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Select one or more workspaces to download as an export.'"
      aria-label="Select one or more workspaces to download as an export."
    >
      <fa-icon [icon]="faDownload"></fa-icon>
      <span>Download</span>
    </button>
  </ng-container>

  <ng-container *ngIf="selectDownloads">
    <button
      class="btn btn-sm btn-link text-primary"
      (click)="download()"
      *ngIf="selectDownloads"
      [disabled]="selected.length < 1"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="selected.length < 1 ? 'Select at least one workspace to download.' : 'Download the selected workspace exports.'"
      [attr.aria-label]="selected.length < 1 ? 'Select at least one workspace to download.' : 'Download the selected workspace exports.'"
    >
      <fa-icon [icon]="faDownload"></fa-icon>
      <span>Download ({{ selected.length }})</span>
    </button>

    <button
      class="btn btn-sm btn-link text-primary"
      (click)="selectDownloads = false;"
      placement="right"
      [tooltip]="'Cancel download selection mode.'"
      container="body"
      triggers="hover focus"
      aria-label="Cancel download selection mode."
    >
      <fa-icon [icon]="faTimes"></fa-icon>
      <span>Cancel</span>
    </button>
  </ng-container>

  <small class="text-muted d-block">
    Tip: Clicking a workspace opens its Settings tab. Use the workspace ID when locating files on disk or for support.
  </small>
</div>

<div *ngIf="showCreatePanel" class="my-2">
  <app-workspace-creator></app-workspace-creator>
</div>

<div *ngIf="isDownloading" class="text-center">
  <app-spinner></app-spinner>
</div>

<div *ngIf="uploaded$ | async as results" class="m-2">
  <alert type="info" [dismissible]="true">
    <span>Upload Results:</span>
    <ul>
      <li *ngFor="let r of results">{{r}}</li>
    </ul>
  </alert>
</div>

<div *ngIf="error_msg">
  <alert type="danger" [dismissible]="true">{{error_msg}}</alert>
</div>

<app-pager [skip]="skip" [take]="take" [count]="count" (changed)="paged($event)"></app-pager>
<hr class="mt-0 mb-2" *ngIf="selected.length > 0" />

<div class="row mb-2 workspace-header align-items-center">
  <div class="col-1" *ngIf="selectDownloads"></div>

  <div [ngClass]="selectDownloads ? 'col-4' : 'col-5'">
    <button
      type="button"
      class="btn btn-link p-0 sort-header header-label text-primary"
      (click)="sortBy('name')"
      placement="right"
      [tooltip]="'Sort by workspace name.'"
      container="body"
      triggers="hover focus"
      aria-label="Sort by workspace name."
    >
      Workspace Name
      <fa-icon *ngIf="sortField === 'name'" [icon]="sortAscending ? faSortUp : faSortDown"></fa-icon>
    </button>
  </div>

  <div class="col-2">
    <button
      type="button"
      class="btn btn-link p-0 sort-header header-label text-primary"
      (click)="sortBy('created')"
      placement="right"
      [tooltip]="'Sort by created date.'"
      container="body"
      triggers="hover focus"
      aria-label="Sort by created date."
    >
      <span class="d-inline-flex align-items-center text-nowrap">
        Created Date
        <fa-icon *ngIf="sortField === 'created'" class="ml-1"
                [icon]="sortAscending ? faSortUp : faSortDown"></fa-icon>
      </span>
    </button>
  </div>

  <div class="col-2">
    <button
      type="button"
      class="btn btn-link p-0 sort-header header-label text-primary"
      (click)="sortBy('activity')"
      placement="right"
      [tooltip]="'Sort by last activity date.'"
      container="body"
      triggers="hover focus"
      aria-label="Sort by last activity date."
    >
      Last Activity
      <fa-icon *ngIf="sortField === 'activity'" [icon]="sortAscending ? faSortUp : faSortDown"></fa-icon>
    </button>
  </div>

  <div class="col-3 d-flex justify-content-end flex-wrap tm-actions">
    <span
      class="header-label text-primary"
    >
      Actions
    </span>
  </div>
</div>

<div *ngFor="let g of (source$ | async); trackBy:trackById"
     class="row mb-1 workspace-row align-items-center">

  <div class="col-1" *ngIf="selectDownloads">
    <input
      type="checkbox"
      [checked]="isSelected(g.id)"
      (change)="select($event, g)"
      style="margin-left: 30px;"
      placement="right"
      [tooltip]="'Select this workspace for download.'"
      container="body"
      triggers="hover focus"
      aria-label="Select this workspace for download."
    >
  </div>

  <div [ngClass]="selectDownloads ? 'col-4' : 'col-5'">
    <button
      type="button"
      class="btn btn-link p-0 mr-2 favorite-btn"
      (click)="toggleFavorite(g.id); $event.preventDefault(); $event.stopPropagation();"
      [attr.aria-label]="isFavorite(g.id) ? 'Unfavorite workspace' : 'Favorite workspace'"
      [tooltip]="isFavorite(g.id) ? 'Unfavorite (pin to top)' : 'Favorite (pin to top)'"
      placement="right"
      container="body"
      triggers="hover focus"
    >
      <fa-icon
        [icon]="isFavorite(g.id) ? faStarSolid : faStarRegular"
        [ngClass]="isFavorite(g.id) ? 'favorite-on' : 'favorite-off'"
      ></fa-icon>
    </button>

    <a
      [routerLink]="['/topo', g.id]"
      class="text-secondary"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Open this workspace (Settings tab).'"
      aria-label="Open this workspace (Settings tab)."
    >
      {{ g.name }}
    </a>

    <br/>
    <small class="text-muted ml-4 d-block text-break">
      <app-clipspan>{{ g.id }}</app-clipspan> &mdash; {{ g.author }}
    </small>
  </div>

  <div class="col-2 d-flex align-items-center">
    <small>{{ g.whenCreated | shortdate }}</small>
  </div>

  <div class="col-2 d-flex align-items-center">
    <small>{{ g.lastActivity | shortdate }}</small>
  </div>

  <div class="col-3 d-flex justify-content-end align-items-center tm-actions">
    <button
      class="btn btn-outline-info btn-sm tm-action-btn mr-2"
      (click)="view(g)"
      placement="right"
      [tooltip]="'Expand to view workspace details and template VM controls.'"
      aria-label="Expand to view workspace details and template VM controls."
      container="body"
      triggers="hover focus"
    >
      <fa-icon [icon]="faList"></fa-icon>
      <span>View</span>
    </button>

    <app-confirm-button
      class="tm-action-host"
      btnClass="btn btn-outline-danger btn-sm tm-action-btn"
      (confirm)="delete(g)"
      aria-label="delete workspace"
    >
      <span
        class="d-inline-flex align-items-center"
        placement="right"
        [tooltip]="'Delete this workspace.'"
        container="body"
        triggers="hover focus"
        aria-label="Delete this workspace."
      >
        <fa-icon [icon]="faTrash"></fa-icon>
        <span>Delete</span>
      </span>
    </app-confirm-button>
  </div>

  <div *ngIf="viewed === g" class="col-12">
    <ng-container *ngIf="detail$ | async as detail">

      <div class="form-group bg-light">
        <label class="mb-0 d-flex align-items-center" for="detail-template-limit">
          Template Limit
          <span
            class="ml-2 text-muted"
            role="button"
            tabindex="0"
            placement="right"
            [tooltip]="'Defines the maximum number of VM templates allowed in this workspace.'"
            container="body"
            triggers="hover focus"
            aria-label="Defines the maximum number of VM templates allowed in this workspace."
          >
            <fa-icon [icon]="faInfoCircle"></fa-icon>
          </span>
        </label>
        <input
          id="detail-template-limit"
          class="form-control"
          type="number"
          [(ngModel)]="detail.templateLimit"
          (change)="update(detail)"
        >
        <small class="text-muted">Maximum number of VMs/templates allowed in the workspace.</small>
      </div>

      <div class="form-group bg-light">
        <label class="mb-0 d-flex align-items-center" for="input-scope">
          Template Scope
          <span
            class="ml-2 text-muted"
            role="button"
            tabindex="0"
            container="body"
            triggers="hover focus"
            placement="right"
            [tooltip]="'Limits which published templates this workspace can link to by scope.'"
            aria-label="Limits which published templates this workspace can link to by scope."
          >
            <fa-icon [icon]="faInfoCircle"></fa-icon>
          </span>
        </label>
        <input
          id="input-scope"
          class="form-control"
          type="text"
          [(ngModel)]="detail.templateScope"
          (change)="update(detail)"
        >
        <small class="text-muted">Template scopes this workspace can link (space-delimited).</small>
      </div>

      <div class="form-group bg-light">
        <label class="mb-0 d-flex align-items-center" for="input-audience">
          Audience
          <span
            class="ml-2 text-muted"
            role="button"
            tabindex="0"
            placement="right"
            [tooltip]="'Limits which users/groups can deploy this workspace as a gamespace.'"
            container="body"
            triggers="hover focus"
            aria-label="Limits which users/groups can deploy this workspace as a gamespace."
          >
            <fa-icon [icon]="faInfoCircle"></fa-icon>
          </span>
        </label>
        <input
          id="input-audience"
          class="form-control"
          type="text"
          [(ngModel)]="detail.audience"
          (change)="update(detail)"
        >
        <small class="text-muted">Audience(s) that can deploy this workspace as a gamespace.</small>
      </div>

      <div *ngFor="let t of detail.templates" class="row mb-1 align-items-center">
        <div class="col-6 text-right">
          <span class="pop-info px-1">{{t.name}}</span>
        </div>
        <div class="col-6">
          <app-vm-controller [template]="t" [fullbleed]="false"></app-vm-controller>
        </div>
      </div>

    </ng-container>
  </div>
</div>

<!-- bottom workspace pager -->
<hr class="my-0" *ngIf="selected.length > 0" />
<app-pager [skip]="skip" [take]="take" [count]="count" (changed)="paged($event)"></app-pager>
