<!-- Copyright 2021 Carnegie Mellon University. -->
<!-- Released under a 3 Clause BSD-style license. See LICENSE.md in the project root. -->

<div class="mb-2">
  <div class="font-weight-bold">Challenge</div>
  <div class="text-muted">
    Use this tab to define transforms (dynamic variables), add challenge Markdown, and configure variants with
    questions and answers. At deploy time, TopoMojo replaces any <code>##key##</code> tokens with generated values.
  </div>
</div>

<div class="d-flex align-items-center mb-2">
  <label class="mb-0 d-flex align-items-center">
    Challenge Editor
    <span
      class="ml-2 text-muted"
      role="button"
      tabindex="0"
      placement="right"
      container="body"
      triggers="hover focus"
      [tooltip]="'Use transforms and ##key## tokens to inject dynamic values into guest settings, challenge text, questions, and answers at deploy time.'"
      aria-label="Use transforms and ##key## tokens to inject dynamic values into guest settings, challenge text, questions, and answers at deploy time."
    >
      <fa-icon [icon]="faInfoCircle"></fa-icon>
    </span>
  </label>

  <div class="spacer"></div>

  <button
    class="btn btn-sm btn-outline-success"
    (click)="save()"
    placement="right"
    container="body"
    triggers="hover focus"
    [tooltip]="'Save your challenge configuration.'"
    aria-label="Save your challenge configuration."
  >
    <fa-icon [icon]="faSave"></fa-icon>
    <span>Save</span>
  </button>
</div>

<form *ngIf="form$ | async as f" [formGroup]="f">

  <div formArrayName="transforms" class="form-group bg-light">
    <label class="d-flex align-items-center mb-0">
      Transforms
      <span
        class="ml-2 text-muted"
        role="button"
        tabindex="0"
        placement="right"
        container="body"
        triggers="hover focus"
        [tooltip]="'Transforms define dynamic values generated at deploy time. Use ##key## anywhere you want the value inserted.'"
        aria-label="Transforms define dynamic values generated at deploy time. Use ##key## anywhere you want the value inserted."
      >
        <fa-icon [icon]="faInfoCircle"></fa-icon>
      </span>
    </label>

    <div>
      <small class="text-muted">
        Add randomization key/values. At deploy-time, values replace keys in template guest settings, challenge text,
        questions, and answers. Enter the plain key here, but use <code>##key##</code> anywhere it should be replaced.
      </small>
    </div>

    <div *ngFor="let t of transforms.controls; let i = index" [formGroupName]="i" class="mt-2">
      <input class="form-control w100" formControlName="key" placeholder="key" aria-label="transform key">
      <input class="form-control w100" formControlName="value" placeholder="value" aria-label="transform value">
      <app-confirm-button btnClass="btn btn-sm btn-outline-dark" (confirm)="removeTransform(i)">
        <fa-icon [icon]="faTrash"></fa-icon>
        <span>Remove</span>
      </app-confirm-button>
    </div>

    <div *ngIf="transforms.controls.length">
      <small class="text-muted">
        Value format is <code>type:range</code> where type is <em>hex, b64, int, uid, list</em> and range is optional.
        <button
          class="btn btn-sm btn-link-warning"
          [(ngModel)]="showTransformExamples"
          [ngModelOptions]="{standalone: true}"
          btnCheckbox
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Show transform type examples.'"
          aria-label="Show transform type examples."
        >
          <fa-icon [icon]="faHelp"></fa-icon>
          <span></span>
        </button>

        <pre *ngIf="showTransformExamples">
id — the gamespace id
variant — the gamespace variant index
hex — yields 8 hex characters
b64 — yields 24 base64 characters
int — yields decimal string
uid — yields a GUID
hex:12 — yields 12 hex characters
b64:16 — yields 16 base64 characters
int:99-999 — yields decimal string between 99 and 999
list:one two three four — yields a single word
list:2:one two three four five — yields two words (and indexed keys `##key_1##`, `##key_2##`)
index:3:zero one two three four — yields "three"
app_url, topomojo_url — this application url (no path)
grader_url — the grading url endpoint
api_key, grader_key — the gamespace apikey (not for participants)
ipv4:cidr_address — yields a random ip in the cidr range
ipv4:192.168.22.0/24 — example result 192.168.22.137
        </pre>
      </small>
    </div>

    <button class="btn btn-sm btn-outline-secondary mt-2" (click)="addTransform()">
      <fa-icon [icon]="faPlus"></fa-icon>
      <span>Add Transform</span>
    </button>
  </div>

  <div class="form-group bg-light">
    <label class="col-form-label-sm d-flex align-items-center mb-0">
      Markdown
      <span
        class="ml-2 text-muted"
        role="button"
        tabindex="0"
        placement="right"
        container="body"
        triggers="hover focus"
        [tooltip]="'This Markdown is appended to the gamespace document when the challenge launches.'"
        aria-label="This Markdown is appended to the gamespace document when the challenge launches."
      >
        <fa-icon [icon]="faInfoCircle"></fa-icon>
      </span>
    </label>

    <ngx-monaco-editor
      id="challenge-text-editor"
      formControlName="text"
      [options]="editorOptions"
      aria-label="challenge text"
    ></ngx-monaco-editor>

    <small class="text-muted">This markdown gets appended to the gamespace document.</small>
  </div>

  <div formArrayName="variants">

    <div class="form-group bg-light">
      <label class="d-flex align-items-center mb-0">
        Variants
        <span
          class="ml-2 text-muted"
          role="button"
          tabindex="0"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'A variant is a different version of the challenge (ISO attachments, VMs, questions/answers). One variant is selected randomly at deploy time.'"
          aria-label="A variant is a different version of the challenge (ISO attachments, VMs, questions/answers). One variant is selected randomly at deploy time."
        >
          <fa-icon [icon]="faInfoCircle"></fa-icon>
        </span>
      </label>

      <p class="mb-1">
        <small class="text-muted">
          At deploy-time, one challenge variant is selected randomly. A variant includes an ISO-attachment instruction
          and one or more question sets.
        </small>
      </p>

      <p class="mb-0">
        <button
          class="btn btn-sm btn-outline-dark mr-1"
          btnCheckbox
          [(ngModel)]="showDetail"
          [ngModelOptions]="{standalone: true}"
          (click)="updateDetail()"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Show or hide detailed question and scoring settings for each variant.'"
          aria-label="Show or hide detailed question and scoring settings for each variant."
        >
          <fa-icon [icon]="showDetail ? faCheck : faUnchecked"></fa-icon>
          <span>Show Variant Detail</span>
        </button>
      </p>
    </div>

    <div *ngFor="let v of variants.controls; let i = index" [formGroupName]="i" class="form-group bg-light mt-2">
      <div class="d-flex align-items-center">
        <label class="label pop-info mb-0">Variant {{i+1}}</label>
        <div class="spacer"></div>

        <button
          class="btn btn-sm btn-outline-dark mr-1"
          btnCheckbox
          [(ngModel)]="detail[i]"
          [ngModelOptions]="{standalone: true}"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Toggle detailed view for this variant.'"
          aria-label="Toggle detailed view for this variant."
        >
          <fa-icon [icon]="faMore"></fa-icon>
          <span>Detail</span>
        </button>

        <button
          class="btn btn-sm btn-outline-dark mr-1"
          (click)="addVariant(v.value)"
          placement="right"
          container="body"
          triggers="hover focus"
          [tooltip]="'Clone this variant.'"
          aria-label="Clone this variant."
        >
          <fa-icon [icon]="faCopy"></fa-icon>
          <span>Clone</span>
        </button>

        <app-confirm-button
          btnClass="btn btn-sm btn-outline-dark"
          (confirm)="removeVariant(i)"
          aria-label="remove variant"
        >
          <fa-icon [icon]="faTrash"></fa-icon>
          <span>Remove</span>
        </app-confirm-button>
      </div>

      <app-variant-form
        [form]="$any(v)"
        [index]="i"
        [detail]="showDetail || detail[i]"
        [guid]="summary.id"
      ></app-variant-form>
    </div>
  </div>

  <button class="btn btn-sm btn-outline-secondary mb-4" (click)="addVariant()">
    <fa-icon [icon]="faPlus"></fa-icon>
    <span>Add Variant</span>
  </button>

</form>

<div class="text-right">
  <button class="btn btn-sm btn-outline-success" (click)="save()">
    <fa-icon [icon]="faSave"></fa-icon>
    <span>Save</span>
  </button>
</div>
